<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bienvenida</title>
</head>
<body>

    <h1>Bienvenido, <span id="user-name">...</span>!</h1>
    <p>La hora actual es: <span id="current-time"></span></p>
    <h2>¡Acceso verificado. Tus permisos están garantizados por el JWT!</h2>

    <button onclick="logout()">Cerrar Sesión</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const userNameElement = document.getElementById('user-name');
            const currentTimeElement = document.getElementById('current-time');

            // Mostrar la hora actual (Requisito 3)
            currentTimeElement.textContent = new Date().toLocaleString();

            if (!token) {
                // Si no hay token, redirigir al login
                window.location.href = "index.html";
                return;
            }

            // Llamada al endpoint protegido (GET /api/welcome)
            fetch("api_welcome.php", {
                headers: {
                    // Enviar el token en la cabecera (Requisito Técnico 2)
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => {
                if (res.ok) { // Éxito (Status 200)
                    return res.json();
                } else if (res.status === 403) {
                    // 403 Forbidden (Token Inválido, Expirado o no Autorizado)
                    throw new Error("No tienes permisos");
                }
                throw new Error("Error en la API: " + res.status);
            })
            .then(data => {
                // Mostrar el nombre del usuario (viene del payload del JWT)
                userNameElement.textContent = data.datos_usuario.username;
            })
            .catch(err => {
                console.error("Error de autenticación o permisos:", err.message);
                // Redirigir a la pantalla de "No Tienes Permisos" (Requisito 4)
                window.location.href = "no_permisos.html";
            });
        });

        // Funcionalidad para Cerrar Sesión (Requisito 5)
        function logout() {
            localStorage.removeItem('token'); // Eliminar el token
            window.location.href = "index.html"; // Redirigir al login
        }
    </script>

</body>
</html>